# 第 7 章：Agent（智能体）—— 赋予 AI 手脚

> 让模型具备规划、记忆与工具使用能力，完成多步任务而非单轮问答。[29][30][31]

!!! note "关于复现、目录与 CI"
    本章中出现的 `make ...`、`CI`、以及示例目录/文件路径（例如 `path/to/file`）均为落地约定，用于说明如何把方法落实到你自己的工程仓库中。本仓库仅提供文档，读者需自行实现或用等价工具链替代。

## 章节定位
本章解决“模型只会说不会做”的问题。你将实现 ReAct/工具调用/多智能体协作，定义安全的工具接口，并用基准任务验证智能体的有效性与鲁棒性。[29][31]

## 你将收获什么
- ReAct + Function Calling 的可复现模板，包含计划、执行、回退与记忆管理。[29][31]
- LangGraph/AutoGen 的多 Agent 编排示例，涵盖角色分工、对话压缩与长程记忆。[30][60]
- 安全护栏：工具白名单、参数校验、速率限制与审计日志。

## 方法论速览
1. **规划与记忆：** 将任务分解为计划—执行—反思循环，外部化记忆（向量库/键值对）。[29]
2. **工具接口设计：** 限定输入模式与幂等性，确保可审计与可重放。[31]
3. **协作与仲裁：** 多 Agent 协作时，引入裁决/仲裁角色，防止回声室与无限循环。[30]

## 实战路径
### 1. ReAct + 工具调用
```python
# 伪代码：规划 + 调用
plan = planner("生成市场周报")
for step in plan:
    if step.tool:
        result = tool_router(step.tool, step.args)
    else:
        result = llm(reason_about=step)
    memory.write(step, result)
```
- 设计工具模式：入参 JSON Schema、超时、重试、敏感操作确认。
- 加入“反思”提示，若结果无用则改写查询或切换工具。

### 2. 多智能体协作
- 使用 LangGraph/AutoGen 定义 Writer、Researcher、Critic 三个角色；限制轮数与 token 上限。[30][60]
- 对于长文档任务，使用摘要链或检索记忆，防止上下文爆炸。

### 3. 安全与可观测
- 工具白名单 + 参数校验 + 速率限制；错误集中到审计日志。
- 每个工具调用记录 trace_id，便于重放与稽核。

### 4. 评估基线
- 构建任务集：网页摘要、报告生成、CSV 计算、邮件草稿。为每类任务设定成功定义与评分规则。
- 使用 `MT-Bench`/自建脚本打分，比较纯 LLM 与 Agent 的增益。[50]

## 复现检查（落地建议）
- `make agent-demo`：启动示例 Agent，完成“周报生成 + 邮件发送”端到端流程。
- `make agent-eval`：运行基准任务并输出分数曲线，低于阈值自动失败。
- 工具调用日志与审计事件需在 CI 打包，供离线审查。

## 常见陷阱
- **工具返回异常未处理：** 需统一异常模型与补偿策略，避免循环卡死。
- **计划膨胀：** 模型生成过长计划，应限制步数并在提示中强调“少即是多”。
- **数据泄露：** 工具输入需过滤敏感信息，日志脱敏。

## 延伸练习
- 为 Agent 增加“合规审计员”角色，专门过滤输出中的泄露或偏见内容。
- 尝试通过 DPO/RLHF 强化 Agent 的工具选择能力（与第 10 章呼应）。

## 交付物与验收（落地建议）
- ReAct/工具调用模板与 LangGraph/AutoGen 编排脚本。
- 任务基准与评估报告，包含失败样本与改进建议。
- 工具白名单、审计日志样例与速率限制配置。

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
