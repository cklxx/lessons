# 第 7 章：Agent（智能体）—— 赋予 AI 手脚

> 让模型具备规划、记忆与工具使用能力，完成多步任务而非单轮问答。[29][30][31]

!!! note "关于复现、目录与 CI"
    本章中出现的 `make ...`、`CI`、以及示例目录/文件路径（例如 `path/to/file`）均为落地约定，用于说明如何把方法落实到你自己的工程仓库中。本仓库仅提供文档，读者需自行实现或用等价工具链替代。

## 章节定位
本章解决“模型只会说不会做”的问题。你将实现 ReAct/工具调用/多智能体协作，定义安全的工具接口，并用基准任务验证 [Agent（智能体）](glossary.md#agent) 的有效性与鲁棒性。[29][31]

## 你将收获什么
- ReAct + Function Calling 的可复现模板，包含计划、执行、回退与记忆管理。[29][31]
- LangGraph/AutoGen 的多 Agent 编排示例，涵盖角色分工、对话压缩与长程记忆。[30][60]
- 安全护栏：工具白名单、参数校验、速率限制与审计日志。

## 方法论速览
1. **规划与记忆：** 将任务分解为计划—执行—反思循环，外部化记忆（向量库/键值对）。[29]
2. **工具接口设计：** 限定输入模式与幂等性，确保可审计与可重放。[31]
3. **协作与仲裁：** 多 Agent 协作时，引入裁决/仲裁角色，防止回声室与无限循环。[30]

## 实战路径
- 示例（可复制）：定义安全工具接口并验证“越权不可用”

```text
目标：
为 Agent 增加一个工具 `send_email(to, subject, body)`，并确保越权/敏感操作必须二次确认且可审计。

上下文：
- 工具清单：tools/registry.json（白名单 + JSON Schema）
- 审计：logs/audit.jsonl（包含 trace_id、principal、tool、args_hash、result）

约束：
- 工具必须有参数校验、超时、重试；敏感参数（收件人/内容）要脱敏落盘。
- 必须有“拒绝调用”用例：当 principal 缺少权限时，Agent 不得触发工具执行。
 

输出格式：
- 只输出 unified diff（git diff 格式）

验证命令：
- make agent-eval

失败判定：
- 出现未授权的工具调用；或审计日志缺少关键字段（trace_id/principal/tool）。

回滚：
- git checkout -- tools/ logs/ tests/
```

### 1. ReAct + 工具调用
```python
# 伪代码：规划 + 调用
plan = planner("生成市场周报")
for step in plan:
    if step.tool:
        result = tool_router(step.tool, step.args)
    else:
        result = llm(reason_about=step)
    memory.write(step, result)
```
- 设计工具模式：入参 JSON Schema、超时、重试、敏感操作确认。
- 加入“反思”提示，若结果无用则改写查询或切换工具。

### 2. 多智能体协作
- 使用 LangGraph/AutoGen 定义 Writer、Researcher、Critic 三个角色；限制轮数与 token 上限。[30][60]
- 对于长文档任务，使用摘要链或检索记忆，防止上下文爆炸。

### 3. 安全与可观测
- 工具白名单 + 参数校验 + 速率限制；错误集中到[审计日志](glossary.md#audit-log)。
- 每个工具调用记录 trace_id，便于重放与稽核。

### 4. 评估基线
- 构建任务集：网页摘要、报告生成、CSV 计算、邮件草稿。为每类任务设定成功定义与评分规则。
- 使用 `MT-Bench`/自建脚本打分，比较纯 LLM 与 Agent 的增益。[50]

## 复现检查（落地建议）
- `make agent-demo`：启动示例 Agent，完成“周报生成 + 邮件发送”端到端流程。
- `make agent-eval`：运行基准任务并输出分数曲线，低于阈值自动失败。
- 工具调用日志与审计事件需在 CI 打包，供离线审查。

## 常见陷阱
- **工具返回异常未处理：** 需统一异常模型与补偿策略，避免循环卡死。
- **计划膨胀：** 模型生成过长计划，应限制步数并在提示中强调“少即是多”。
- **数据泄露：** 工具输入需过滤敏感信息，日志脱敏。

## 延伸练习
- 为 Agent 增加“合规审计员”角色，专门过滤输出中的泄露或偏见内容。
- 尝试通过 DPO/RLHF 强化 Agent 的工具选择能力（与第 10 章呼应）。

## 交付物与验收（落地建议）
- ReAct/工具调用模板与 LangGraph/AutoGen 编排脚本。
- 任务基准与评估报告，包含失败样本与改进建议。
- 工具白名单、审计日志样例与速率限制配置。

下面把本章的 Agent 工程实践抽象为可迁移原则：你可以换编排框架，但不换“权限边界、可审计、可回退”的护栏。

## 深度解析：核心原则
1. **工具即权限边界**：把工具接口当作安全边界（白名单 + Schema + 超时/重试/确认）；模型永远不直接拥有“执行权限”。[31]
2. **停止条件优先**：显式限制步数、预算（token/时间）、失败重试次数；把“无限循环/回声室”视为必须可复现的缺陷。[29][30]
3. **审计与可重放**：每次工具调用必须可追溯（trace_id、principal、参数哈希、结果摘要），支持离线复盘与事后稽核。[61]
4. **基准任务说话**：用固定任务集比较“纯 LLM vs Agent”的增益，并把失败样本回写到提示与工具设计中，而不是靠主观体验。[50]

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
