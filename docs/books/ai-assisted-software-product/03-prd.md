# 第 3 章：PRD 与工程合同（Definition）：从愿景到验收
![第 3 章封面](../../assets/chapter_03_header_1766035377980.png)

> PRD 不是需求作文，而是一份可裁决的合同：它要让争议有裁判，让交付有门槛，让回滚有预案。写得短可以，但不能写得含糊。[11][12]

当 AI 让实现变快，PRD 的价值反而更大了：你需要一份能约束生成的边界，让速度落在正确方向上；你也需要一份能保护未来的你的记忆，让两周后的自己仍能回答：当时为什么要这样做。[4]

## 章节定位
本章位于需求挖掘与原型验证之间，解决一个核心问题：把想做什么写成做到什么算完。你将把 PRD 当作合同来写：先锁定范围，再补齐失败边界，最后把验收标准写到可复核的程度。[5][18]

## 你将收获什么
- 一套最小 PRD 合同结构：目标/非目标、用例（含异常流）、NFR、验收标准、回滚策略。
- 一份用例清单写作法：把失败与补偿路径写成一等公民，减少上线后的返工。[12]
- 三份可直接复用的模板：一页 PRD、用例清单、验收与决策记录表。[11]

## 三层思考：把 PRD 写成可交付系统
### 第 1 层：读者目标（你到底想用 PRD 解决什么）
你不是为了写文档而写 PRD，而是为了三件事：
- **收敛范围**：明确不做什么，避免功能膨胀。
- **统一语义**：关键名词、状态、错误边界不靠口头记忆。
- **裁决交付**：上线前不靠争论，靠清单与门槛。

### 第 2 层：论证链条（从问题到验收的闭环）
一份能推进交付的 PRD，逻辑链条应当闭合：

问题证据 → 目标/非目标 → 用户与场景 → 用例（含异常流）→ 需求拆分 → NFR 与预算 → 指标口径 → 验收与回滚 → 决策记录

这条链条里最容易缺的是异常流、NFR、回滚。缺它们，PRD 会在实现阶段变成隐性返工。[5][6]

### 第 3 层：落地与验收（怎么判断 PRD 写对了）
把 PRD 当作合同，它至少要通过三类读者的审查：
- **产品视角**：目标清晰、范围收敛、价值闭环能发生。
- **工程视角**：边界清晰、失败可恢复、实现可拆分。
- **治理视角**：风险可控、成本有上限、退化可回滚。

任何一类审查无法完成，都说明 PRD 还不够可交付。

## 方法论速览：四步写出最小合同
1. **先写一页 PRD，再写细节**：用一页纸冻结你在做什么/不做什么/怎么验收。[11]
2. **用例优先，异常流必须具名**：把失败与补偿路径写进用例清单（超时、重试、权限不足、退款/撤销、幂等等）。[12]
3. **NFR 不是附录，是边界**：SLO、成本预算、隐私边界与守门指标必须提前写下。[6]
4. **验收标准要可回归**：每条验收都能映射到一次检查（测试、日志、监控、对比表），否则它只是愿望。[18]

![图 3-1：PRD 逻辑链（证据→范围→用例→NFR→验收→回滚）示意](../../assets/figure_03_1_1765970838431.png)

## 把口气改成合同语言：用 RFC 2119 写验收条款
PRD 里最常见的模糊，不是漏了某个功能，而是用了含糊的口气：应该、尽量、最好、支持一下、优化一点……这些词在讨论时很顺滑，在交付时却没有裁判。  
一个实用的改法是：把关键条款改写成 RFC 2119 的合同语言——**MUST / SHOULD / MAY**，并给出边界与例外。[74]

你会发现，一旦你被迫写出 MUST，你就会自然地补齐三件事：  
1) 这个 MUST 的触发条件是什么？  
2) 做不到时怎么办（降级/拒绝/回滚）？  
3) 怎么验收（证据在哪里、口径是什么）？[74][18]

但别把 MUST 当作文法游戏。每个 MUST 都是在争资源：它意味着实现成本、依赖、风险与责任边界。建议把关键条款补齐成本、责任与降级，否则合同只会在评审会上好看。

| 条款（MUST/SHOULD） | 触发条件 | 验收证据 | 成本/责任（谁实现/谁维护） | 降级/回滚 |
| --- | --- | --- | --- | --- |
| 导入失败时 MUST 给出失败原因与恢复入口 | 校验失败/网络中断/权限不足 | UI 状态 + 错误码 + 日志字段 | 前端/后端共同 | 可关闭入口；可降级为手工导入 |

## 把合同变成门禁：可执行规格（OpenAPI + Spectral 只是其中一种）
当能力需要被前端/第三方/Agent 工具调用时，契约就不该只存在于 PRD 的文字里。一个可落地的做法是把它落到可机器校验的规格里，然后把校验变成 CI 门禁：不符合合同条款就不允许合并。[67][65]

这里用 OpenAPI + Spectral 举例，是因为接口契约最容易落到可运行门禁。但同样的思路也适用于：埋点事件 schema、数据契约（表结构/约束）、前端状态与错误语义映射等——只要它能被校验，就能成为门禁。

![图 3-4：PRD → OpenAPI → Spectral → CI 门禁](../../assets/figure_03_4_prd_ci_pipeline_1766373696972.png)

!!! note
    作图提示：建议画成一条管道，从条款到门禁一路可追溯。
    - 左侧：PRD（条款用 MUST/SHOULD/MAY 写）
    - 中间：OpenAPI（字段/错误/分页/鉴权/幂等等落到契约）
    - 右侧：Spectral 规则集（基础语法 → 一致性 → 产品合同）
    - 最右：CI（破坏性变更 fail + PR 评论给出人话原因）

把它写成一条流水线，会让合同从文档变成系统默认属性：

```text
PRD（MUST/SHOULD/MAY 的条款）
  → OpenAPI（字段/错误语义/分页/鉴权/幂等等落到契约）
  → Spectral 规则（语法一致性 → 产品合同约束）
  → CI 门禁（破坏性变更 fail，并在 PR 里给出可读原因）
```

## 模板 1：一页 PRD（MVP 合同）
用法：先写这一页，再允许自己写任何细节。写不满一页不是问题；写不清一句话才是问题。

![图 3-2：一页 PRD 视觉示例](../../assets/figure_03_2_one_page_prd_1766373715477.png)

!!! note
    作图提示：建议画成一页纸卡片，结构简单但可验收。
    - 顶部：一句话愿景 + 目标用户
    - 中部：目标/非目标（左右两栏对照，避免范围漂移）
    - 右侧：NFR 与守门指标（延迟/成本/风险）
    - 底部：验收门槛 + 回滚开关（用触发条件→动作表达）

| 模块 | 你要写什么 | 写不清会发生什么 |
| --- | --- | --- |
| 一句话愿景 | 为谁解决什么问题 | 讨论会变成各说各话 |
| 问题证据 | 3 条以内：日志/反馈/访谈摘要 | 你会把热闹当需求 |
| 目标（3 条以内） | 可量化或可验证的结果 | 上线后无法裁决成败 |
| 非目标（3 条以内） | 明确不做什么 | 范围失控、永远做不完 |
| 核心闭环 | 3–5 个关键动作 | 原型/实现偏离关键路径 |
| 用例列表 | 5–10 条：含异常流 | 上线后在失败边界返工 |
| 外部依赖与索引 | 依赖系统/接口/数据源/合规要求 + 链接 | 实现时才发现卡死 |
| NFR 与守门指标 | 延迟/成本/风险底线 | 优化会越做越亏 |
| 验收与回滚 | 通过门槛 + 回滚开关 | 事故发生时无退路 |
| 开放问题 | 需要拍板的 3 项以内 | 团队/未来的你无法继续 |

## 模板 2：用例清单（含异常流）
用法：用例不是用户故事的散文，而是系统的真实合同。每条用例都必须包含失败与恢复。

| 用例 ID | 目标用户 | 触发条件 | 成功路径（最多 5 步） | 失败/补偿路径（至少 2 条） | 验收证据 |
| --- | --- | --- | --- | --- | --- |
| UC-01 | 谁 | 什么时候 | 1→2→3→… | 超时/重试；权限不足；输入无效；撤销/退款；幂等去重 | 日志、截图、指标对比 |

### 一个小示例：把导入数据写成可验收用例
- 成功路径：选择文件 → 校验格式 → 导入完成 → 给出下一步引导
- 失败/补偿：格式错误（指出行列与修复建议）；网络中断（可重试/可续传）；权限不足（明确申请入口）
- 验收证据：导入成功率、平均耗时、失败后恢复率（同口径对比表）[6]

## 把验收写到前端：让产品与工程说同一种话
PRD 最常见的后遗症是：验收标准写在文档里，但产品界面不承认它——用户看不到进度、看不到失败原因、看不到恢复入口；最后验收只能靠口头解释，体验也只能靠感觉不错。如果你想让 PRD 真正约束交付，建议你把验收拆成两层：

- **用户可见的验收**：界面上能看到的状态、提示、恢复入口、预算/权限信息。
- **系统可证据的验收**：日志字段、指标曲线、回归报告、灰度对比表。

当两层能对齐，你就能做到：上线前靠清单验收，上线后靠证据复盘，退化时靠回滚止损。[5][18]

![图 3-3：验收映射表](../../assets/figure_03_3_acceptance_criteria_map_1766373734131.png)

!!! note
    作图提示：建议画成四列映射，左边是用户感知，右边是系统证据与回滚。
    - 列 1：PRD 验收条目（用户任务视角）
    - 列 2：前端可见状态/文案（用户能理解、能行动）
    - 列 3：后端证据（日志字段/指标/trace_id）
    - 列 4：回滚/降级动作（越界时系统怎么退一步）

你可以把它落到一张四列映射表：左边是用户感知，右边是系统证据，中间用同一件事把两者钉死。

| PRD 验收条目（用户任务视角） | 前端可见状态/文案（可理解、可行动） | 后端证据（日志字段/指标/trace_id） | 回滚/降级动作（越界时怎么退一步） |
| --- | --- | --- | --- |
|  |  |  |  |

## 模板 3：验收标准（可裁决写法）
你可以用清单，也可以用 Given/When/Then，但必须满足可观察、可复核、可回滚。

建议每条验收标准都包含四个元素：
1. **条件**：在什么前提下（用户类型/权限/网络/数据规模）。
2. **动作**：用户做了什么或系统做了什么。
3. **可观察结果**：页面变化、返回语义、日志字段、指标变化。
4. **失败与恢复**：失败时用户如何自救？系统如何补偿？回滚如何触发？

## AI 怎么用在 PRD 上（但不替你做裁决）
把 AI 放在补全与找漏洞上，而不是放在拍板上：
- 让 AI 帮你补齐异常流清单，并要求它按现象/触发条件/用户可恢复路径/系统补偿输出。[12]
- 让 AI 帮你把目标改写为可证伪句式，并给出反例与验证方法。[4]
- 让 AI 扮演挑刺评审：只输出歧义点、缺失的守门指标、可能的越权/合规风险。[6]

为了避免生成通用废话，建议把上下文写死、把输出格式写死、把禁止项写死。下面两个 prompt 模板可以直接复制复用（建议和 PRD 一起入库，作为工作台工件的一部分）：

```text
任务：补全异常流与补偿路径（只输出表格）。
输入：用户故事 + 关键数据结构/权限模型 + 现有约束（SLO/成本/合规）。
输出：Markdown 表格，列：现象 | 触发条件 | 用户可恢复路径 | 系统补偿/幂等 | 验收证据 | 守门指标/风险。
规则：不得编造业务事实；信息不足就输出需要补充的问题；必须给出可验收证据。
```

```text
任务：列出边界值与攻击向量（只输出清单）。
输入：一页 PRD（目标/非目标/用例/NFR/回滚）。
输出：最多 12 条，每条包含：风险点一句话 + 最小复现条件 + 建议门禁（测试/日志/阈值）+ 回滚动作。
规则：优先写特定业务而非断网/超时这类通用项；不确定就写未知。
```

## 关键流程图（纯文本）：PRD 合同到门禁

```text
Discovery 输出（假设/证据/反例） -> 一页 PRD 合同（目标/非目标/回滚）
  -> 用例清单（成功+异常+恢复） -> 验收标准（可观察证据）
    -> NFR/预算（守门指标+越界动作） -> 变更协议（同 PR 原子提交）
      -> 实现与回归 -> 对比表 -> 裁决（合并/回滚/暂停）

门禁（任一缺失视为未完成）：
- 缺异常流与恢复入口 -> 不允许进入实现
- 验收无证据口径 -> 不允许宣称已完成
- 守门指标缺失或无越界动作 -> 不允许灰度
```

## 示例（可复制）：一页 PRD 合同 + 异常流表 + 门禁条款

**目标：** 把一个功能写成可交付合同，并能在评审时当场裁决是否可以进入实现。

**前置条件：**
- 有一个明确的用户任务（例如上传文档后可提问并得到带引用的回答）
- 你愿意把 PRD 当合同，并把失败与回滚写进去

**输出格式：**
- PRD：`docs/prd/prd-001.md`
- 用例清单（含异常流）：`docs/prd/use-cases.md`
- 验收与门禁：`docs/prd/gates.md`

**步骤：**
1. 用一页 PRD 写清目标/非目标/回滚与守门指标（至少延迟/成本/风险三类）。[6]
2. 用例表强制写异常流：解析失败、无权限、证据不足、预算越界、外部依赖失败，并写清用户可恢复入口与系统补偿。[12]
3. 把验收条款改写为可观察证据：页面状态、日志字段、指标阈值、对比表口径；缺证据的条款视为未写完。[18]

**验证命令：**
```bash
python3 - <<'PY'
from pathlib import Path

prd = Path('docs/prd/prd-001.md')
if not prd.exists():
  raise SystemExit('missing docs/prd/prd-001.md')

text = prd.read_text(encoding='utf-8', errors='replace')
must = ['背景', '目标', '非目标', '验收', '回滚', '守门']
missing = [k for k in must if k not in text]
if missing:
  raise SystemExit(f'missing sections in PRD: {missing}')

print('ok')
PY
```

**失败判定：**
- 无法回答三件事：做到什么算完、失败怎么判定、退化怎么回滚。
- 验收条款无法映射到证据（日志/指标/截图/对比表）。

**回滚：**
- PRD 以版本号更新，保留旧版本作为审计；实现侧必须与 PRD 同 PR 原子更新，避免合同与实现漂移。

## 复现检查清单（本章最低门槛）
- 一页 PRD 合同已完成：目标/非目标/闭环、验收、回滚齐全。[11]
- 用例覆盖异常流：每条关键链路至少 2 条失败/补偿路径，并写清用户可恢复入口与系统补偿/幂等策略。[12]
- NFR 与预算可裁决：至少包含延迟/成本/风险三类守门指标，并写清越界动作（降级/回滚/暂停）。[6]
- 验收可复核：每条验收都能对应到可回放证据（日志/指标/截图/对比表）；缺证据视为未验收。[18]

## 常见陷阱（失败样本）
1. **现象：** PRD 看起来很完整，但实现时仍然频繁理解不一致。  
   **根因：** 关键语义、错误边界与边界值没写清；用例只写成功路径，失败与恢复靠脑补。  
   **复现：** 让两位实现者各自描述同一条异常输入应返回什么错误、前端应展示什么恢复入口，出现多处口径不一致。  
   **修复：** 把分歧点落到用例表 + 错误语义 + 验收条款；先把失败与恢复写清，再谈优化。[12][18]  
   **回归验证：** 每条关键异常都有用例与验收条款；实现 PR 能引用到对应条目，并能用日志字段或测试用例复核。[18]

2. **现象：** 上线后总在补非功能需求，进度被拖垮。  
   **根因：** 把 NFR 当成最后再补的附录；缺少守门指标、预算上限与越界动作。  
   **复现：** PRD 里找不到延迟/成本/风险的阈值与回滚条件；灰度时指标越界只能靠人工拍板。  
   **修复：** 在 PRD 阶段就写下守门指标与越界动作（降级/回滚/暂停），并把观测字段写进合同。[6]  
   **回归验证：** 灰度策略卡包含守门指标阈值；越界时系统能按表降级或回滚，并产出证据包。[6]

3. **现象：** PRD 承诺了很多，但最终交付物无法验收。  
   **根因：** 验收标准不可观察、不可复核；用体验更好这类句子替代门槛。  
   **复现：** 问怎么证明达标，只能给主观描述，找不到日志/指标/截图/对比表。  
   **修复：** 把验收改写为可观察结果 + 证据位置，并提前定义失败判定与回滚动作。[18]  
   **回归验证：** 每条验收都有对应证据（报告/日志/指标）；门禁脚本失败时能定位到具体条目与原因。

## 变更协议：让合同在迭代中存活
敏捷不是不写合同，而是把变更写进合同。一个最小可执行的变更协议是：任何影响范围、门槛、守门指标、回滚策略的改动，都必须以变更卡片 + PRD 同步更新的方式进入版本库。

- **入口唯一**：每次变更先写一张变更卡片（Why/What/Gate/Fail/Rollback/Evidence），再允许改代码。
- **同 PR 原子提交**：改动实现的 PR 必须同时更新 PRD 与验收门禁；只改实现不改合同视为未完成。
- **门槛先行**：先改门槛与失败判定，再改实现；否则会变成做完再找理由。
- **证据留档**：每次合并必须产出对比表/回归报告并给出路径；没有证据就当没有改进。

## 交付物清单与验收标准
- PRD（含一页合同 + 用例清单 + NFR + 验收与回滚）。
- 决策记录（开放问题、拍板结论、保留反例与理由）。[4]
- 验收清单（可复核证据的位置与口径）。[18]

## 下一章
PRD 解决做到什么算完，原型解决关键路径能不能发生。下一章见：[04-prototype.md](04-prototype.md)。

## 参考
详见本书统一参考文献列表：[references.md](references.md)。
