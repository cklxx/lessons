# 第 11 章：用户模块：认证、授权与审计
![Chapter 11 Header](../../assets/figure-placeholder.svg)

> “能登录”不等于“能上线”。0→1 最容易出事故的地方往往是权限边界不清、审计缺失、账号体系一改就崩。本章把用户模块当作生产系统的底座来写：边界清晰、可追溯、可回滚。[22][68]

AI 产品会把用户模块的风险放大：一旦越权，泄露的不只是页面数据，还可能是知识库、提示词、工具调用结果与审计日志本身。你必须把“默认安全”做成系统属性，而不是靠记得“这里要校验一下”。[68]

## 章节定位
本章位于智能层之后，进入“产品模块”。原因很简单：只要你开始提供保存、共享、团队协作、计费或知识库，你就必须先把身份与权限边界写清楚。否则你后面的每一章都会在同一个地方反复返工：谁能看到什么、谁能做什么、出了事怎么追责。[22]

## 你将收获什么
- 一个可迁移的用户模块边界：AuthN/AuthZ 分层、租户隔离、资源级权限。
- 一套审计口径：关键事件、字段、追踪标识，让事故可复盘可追责。[68]
- 一张最小门禁：越权阻断、敏感操作可追溯、凭证策略可回滚。

## 三层思考：用户模块的价值不是“登录”，是“边界”
### 第 1 层：读者目标
你要交付的是一个可托付的系统底座：权限清晰、越权可回归、关键操作可追溯。

### 第 2 层：论证链条
用户模块的链条是：

身份体系（AuthN）→ 权限模型（AuthZ）→ 租户隔离 → 审计事件 → 回归用例 → 变更与回滚

缺一环，安全会变成“人的记忆”，而人的记忆在压力下最不可靠。[68]

### 第 3 层：落地与验收
验收不靠“看起来没问题”，而靠三条硬门槛：
- 任何跨租户访问都必须失败（服务端阻断，而不是 UI 隐藏）。[68]
- 敏感操作必须产生审计事件（谁、何时、对什么、做了什么、结果如何）。[68]
- 权限变更必须可灰度与可回滚（避免“一改全崩”）。

## 方法论速览：先定模型，再定事件，再写回归
![图 11-1：用户模块分层（AuthN/AuthZ/审计/租户隔离）示意（占位）](../../assets/figure_11_1_1765971227695.png)

### 1) 身份体系（AuthN）：你是谁
AuthN 的核心是“凭证生命周期”：签发、过期、撤销、轮换。0→1 阶段不追求花哨，但必须可解释可撤销。[22]

你要回答三件事：
- 你支持哪些登录方式（邮箱、第三方、企业 SSO）？
- 凭证如何失效（登出、改密、风控封禁）？
- 会话如何被追踪（用于审计与风控）？

### 2) 权限模型（AuthZ）：你能做什么
推荐从“最小可用三件套”起步：
- **主体（Subject）**：用户/服务账号/团队。
- **客体（Resource）**：项目、文档、知识库、账单等资源实例。
- **动作（Action）**：read/write/admin 等动作集合。[68]

最重要的不是你选 RBAC 还是 ABAC，而是：权限必须可测试、可审计、可迁移。

**模板：权限模型一页纸**

| 项目 | 写法 |
| --- | --- |
| 主体 | 用户/团队/服务账号的定义 |
| 资源 | 需要保护的资源清单与标识方式 |
| 动作 | read/write/admin 等最小集合 |
| 角色 | 角色与动作映射（可选） |
| 租户隔离 | tenant_id 如何贯穿与校验 |
| 默认策略 | 默认拒绝还是默认允许（推荐默认拒绝） |

### 3) 租户隔离：0→1 最常见的“致命漏洞”
多租户产品里，最贵的事故是跨租户数据泄露。最低要求：
- 任何资源查询都必须带租户上下文；
- 任何缓存键都必须包含租户信息（避免串数据）；
- 任何导出/分享都要有显式授权与审计。[68]

### 4) 审计：把“背锅”变成“可追责”
审计日志是事故复盘的事实源，也是很多企业客户付费的理由之一。[68]

**模板：审计事件规范**

| 字段 | 说明 |
| --- | --- |
| who | user_id / service_id |
| when | timestamp |
| where | request_id / trace_id / ip（视合规） |
| what | resource_type + resource_id |
| action | read/write/admin/… |
| result | success/fail + reason |
| context | tenant_id、权限决策摘要 |

建议你先列“必须审计”的事件，再实现功能：登录、权限变更、导出/删除、计费相关操作、知识库变更等。[68]

### 5) 回归：把越权当成阻断级失败
权限系统最怕“改一处、崩一片”。你需要把越权用例写成固定回归集：
- 跨租户读取必须失败；
- 角色降权后访问必须失败；
- 权限变更必须产生审计事件。[68]

## 复现检查清单（本章最低门槛）
- 权限模型一页纸已完成：主体/资源/动作/租户隔离清晰。[68]
- 越权回归用例存在：跨租户与资源级权限必测，失败即阻断发布。[68]
- 审计事件规范存在：关键操作可追溯可查询。[68]
- 权限变更有回滚策略：能在事故时快速回到旧策略。

## 常见陷阱（失败样本）
1. **现象**：UI 隐藏了按钮，但接口仍然可调用。  
   **根因**：把“前端显示逻辑”当成“授权”。  
   **修复**：授权必须在服务端做，并有越权回归用例。[68]

2. **现象**：权限改一次，线上就出现大量“无法访问”。  
   **根因**：权限模型缺少迁移策略与兼容窗口。  
   **修复**：权限变更需要版本化与灰度；先兼容旧策略，再切换新策略，并保留回滚路径。

3. **现象**：出了事故无法追责，只能猜。  
   **根因**：审计字段缺失或不一致，无法串起链路。  
   **修复**：先统一审计事件规范；缺审计视为未完成。[68]

## 交付物清单与验收标准
- 权限模型说明与变更策略（含租户隔离）。[68]
- 审计事件规范与查询方式（能快速定位一条关键操作）。[68]
- 越权回归集（固定攻击用例），回归不过不发布。[68]

## 下一章
用户模块决定“谁能做什么”。下一章把商业闭环落到系统：订阅、计费、账本、对账与风控。见：[`12-billing.md`](12-billing.md)。

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
