# 第 10 章（RAG 深入）：把“回答”改造成“带证据的结论”
![Chapter 10 RAG Header](../../assets/figure-placeholder.svg)

> RAG 的本质不是“让模型变聪明”，而是让它“有根据”：每一句关键结论都能回指到来源；没有证据就拒答或追问。[24][6]

这一章不从工具讲起，而从合同讲起：你要和用户、和系统、和未来的你签一份“引用合同”。有了合同，RAG 才会从演示走向生产：可追溯、可回归、可治理。

## 章节定位
本章是第 10 章的深入版，聚焦 RAG 的证据链：从语料选择到切分、检索、重排，再到“强制引用”的输出格式与评测门禁。你可以把它理解为：把“模型输出”变成“可审计结论”的方法手册。[24]

## 你将收获什么
- 一份“引用合同”：回答必须包含什么证据，缺证据如何处理。
- 一张 RAG 设计卡：数据范围、更新策略、检索策略、重排策略、拒答策略。
- 一套回归门禁：让你能证明一次改动是“更好”，而不是“更像”。[6]

## 三层思考：RAG 的核心矛盾
### 第 1 层：读者目标
让用户敢信：他们能看到来源，能复核关键结论，能在不足时得到合理的拒答或追问。

### 第 2 层：论证链条
RAG 的链条是：

语料边界 → 数据清洗与元信息 → 切分策略 → 检索策略 → 重排策略 → 生成与引用合同 → 评测回归 → 线上审计

其中最常被忽略的是“语料边界”和“引用合同”。没有边界，你不知道该不该回答；没有合同，你不知道答得对不对。[24][6]

![图 10-2：RAG 证据链（语料→切分→检索→重排→引用合同→回归）示意（占位）](../../assets/figure_10_2_1765971137389.png)

### 第 3 层：落地与验收
验收不靠“答得像不像”，而靠：
- 引用缺失率是否可控（理想情况：关键结论必须有引用）；[24]
- 引用是否“贴题”（引用的片段能支持结论，而不是凑数）；
- 退化是否可回滚（回归集不过即回滚）。[6]

## 第一件事：写“引用合同”（把证据链写进接口）
你要先决定：在你的产品里，“可信回答”意味着什么。一个可落地的合同至少包含四条：
- **必须引用**：关键结论必须给出来源（来源标识 + 片段摘要/引用段落）。
- **必须对齐**：引用要能支持结论；不支持视为“无引用”。
- **必须承认不足**：证据不足时必须拒答或追问，不允许编造。
- **必须可追溯**：系统能记录检索输入、候选来源与最终引用（用于审计与回归）。[24][6]

**模板：引用合同（可直接贴进 PRD/评测规范）**

| 条款 | 规则 | 失败判定 |
| --- | --- | --- |
| 引用必填 | 关键结论必须附来源 | 无来源即失败 |
| 引用贴题 | 引用片段能支持结论 | “引用-结论不匹配”视为失败 |
| 证据不足 | 必须拒答或追问 | 编造/强答视为失败 |
| 可追溯 | 记录检索与引用 | 缺审计字段视为失败 |

## 第二件事：语料边界（决定“什么问题可以答”）
RAG 最致命的问题不是检索不到，而是检索到“看似相关但不该用”的东西。你需要明确语料边界：
- **范围边界**：哪些来源属于“权威”，哪些只是“参考”。
- **新鲜度边界**：过期信息是否允许引用？如何提示？
- **合规边界**：哪些数据不允许进入语料或不允许被引用展示（隐私、机密）。[6]

**模板：语料边界卡**

| 维度 | 你要写清楚 |
| --- | --- |
| 允许来源 | 文档类型/域名/仓库/数据库 |
| 禁止来源 | 私密、未授权、含敏感信息 |
| 更新策略 | 多久更新一次；如何回滚到旧索引 |
| 新鲜度提示 | 过期如何提示；是否拒答 |
| 展示策略 | 引用是否可见；是否可下载 |

## 第三件事：切分与元信息（让检索可控）
切分不是“把文本切小”，而是让“证据颗粒度”与“回答颗粒度”对齐：
- 太大：引用不贴题，用户不信；成本与延迟上升。
- 太小：语义断裂，检索召回下降；回答缺上下文。

比切分更关键的是元信息：来源、章节、时间、权限、主题标签。没有元信息，你很难做过滤、去重与权限控制。[6]

**模板：切分与元信息清单**
- 来源标识（可追溯到原文位置）
- 时间戳（用于新鲜度）
- 权限标签（用于租户/角色隔离）
- 主题标签（用于过滤与分析）
- 文档类型（规范/FAQ/公告/代码注释等）

## 第四件事：检索与重排（把“相关”变成“可用”）
你可以把检索当作两步：
1. **召回**：宁可多一点，保证不漏关键证据。
2. **重排**：宁可少一点，保证留下的都“贴题”。[24]

0→1 阶段的实践建议是：先把“召回稳定”做出来，再谈复杂策略。因为召回不稳定时，任何生成策略都像在沙地上建房。

**模板：检索策略卡（最小可控版本）**

| 维度 | 选择 | 你要关注的风险 |
| --- | --- | --- |
| 召回范围 | Top-K（初始偏大） | K 太小会漏证据 |
| 过滤 | 权限/新鲜度/类型 | 过滤过严会“答不出来” |
| 去重 | 相似片段合并 | 不去重会浪费上下文 |
| 重排 | 让更贴题的靠前 | 不重排会引用凑数 |

## 第五件事：生成阶段（让模型“引用优先”）
生成阶段的关键不是写得华丽，而是遵守引用合同：
- 先列证据，再写结论；
- 每条结论都对应来源；
- 不确定就追问，不编造。[24]

你可以把“回答结构”固定下来，降低漂移：
- 结论（简短）
- 依据（引用列表 + 关键片段摘要）
- 适用条件与例外（边界）
- 下一步建议（如果需要行动）

## 第六件事：安全：把语料当作不可信输入
RAG 有一个独特的攻击面：**检索注入**。文档里可能包含“指令”，诱导模型泄露系统提示、绕过边界或调用工具。[29]

最低防护原则：
- 文档内容只作为“事实来源”，不作为“指令来源”。
- 任何来自语料的“命令式句子”都应被忽略或降权。
- 命中注入样本视为阻断级失败，并进入回归集。[6][29]

## 评测与回归：让你敢迭代
RAG 的评测至少要回答三件事：
- **证据覆盖**：关键证据能否召回（不漏）。
- **引用贴题**：引用是否支持结论（不凑）。
- **拒答质量**：证据不足时能否合理拒答/追问（不编造）。[24][6]

**模板：RAG 回归样本字段（最小集合）**

| 字段 | 说明 |
| --- | --- |
| 问题 | 用户输入 |
| 期望要点 | 关键结论（可简写） |
| 期望来源 | 应引用的来源标识（可选） |
| 标签 | 主题/难度/攻击类型 |
| 判定 | 通过/失败 + 原因 |

## 复现检查清单（本章最低门槛）
- 引用合同已写成规则，并进入发布门禁：无引用即失败。[24]
- 语料边界清晰：允许/禁止来源、新鲜度与回滚策略明确。[6]
- 有一份回归集：至少包含“缺证据”“过期证据”“注入样本”三类。[6][29]
- 每次改动能给出对比表：引用缺失率、贴题率、拒答质量与成本/延迟。[6]

## 常见陷阱（失败样本）
1. **现象**：引用很多，但用户仍不信。  
   **根因**：引用不贴题，或引用不支持结论。  
   **修复**：把“贴题”写进门禁；引用-结论不匹配视为无引用。[24]

2. **现象**：答不出来的情况越来越多。  
   **根因**：过滤过严或语料边界不清；把“安全”做成了“沉默”。  
   **修复**：区分“拒答”与“追问”；追问要给下一步行动，让用户能继续推进。

3. **现象**：线上出现越狱/注入导致的危险输出。  
   **根因**：把文档当成可信指令；缺攻击回归。  
   **修复**：把注入样本纳入固定回归集；命中即阻断。[6][29]

## 交付物清单与验收标准
- 引用合同与门禁阈值。[24]
- 语料边界卡与更新/回滚策略。[6]
- 回归集与对比表（含注入样本）。[6][29]

## 下一章
RAG 让“回答带证据”。当你需要“让系统去做事”，你将进入 Agent：工具边界、预算与停止条件、审计与回滚。见：[`10-agent-rag-agent.md`](10-agent-rag-agent.md)。

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
