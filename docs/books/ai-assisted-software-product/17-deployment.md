# 第 17 章：部署与运维：灰度、监控与回滚
![Chapter 17 Header](../../assets/figure-placeholder.svg)

> 上线不是“把版本推上去”，而是把不确定性纳入治理：你知道如何灰度、如何观测、如何回滚、如何复盘。没有回滚的发布，等价于赌博。[5][6]

AI 产品的运维挑战更尖锐：模型/提示/检索/工具任何一处变化都可能改变行为分布；你不只要监控错误率，还要监控质量、成本与风险面。把这些纳入发布门禁，你才能持续迭代而不被线上事故拖垮。[6]

## 章节定位
本章承接推理优化与评测门禁，讲“如何安全地发布与长期运行”：版本管理、灰度策略、监控口径、回滚与复盘。它的目标是让你在低资源条件下仍能建立“可控上线”的操作系统。[5]

## 你将收获什么
- 一套发布策略：从小流量灰度到全量，何时推进、何时暂停、何时回滚。[5]
- 一份运维观测口径：质量/延迟/成本/风险四线同看。[6]
- 一份 Runbook 模板：事故发生时你按表执行，而不是凭情绪决策。[5]

## 三层思考：运维是“让系统长期不坏”
### 第 1 层：读者目标
你要获得持续迭代的能力：上线不怕、退化可控、事故可复盘。

### 第 2 层：论证链条
可控发布链条是：

版本化（代码/配置/提示/模型）→ 灰度策略 → 观测口径 → 告警与处置 → 回滚与复盘 → 回归集更新

缺版本化，你无法解释变化；缺回归集，你无法防止复发。[6]

### 第 3 层：落地与验收
验收看三件事：
- 你能明确说明“这次发布改了什么”（可追溯）；
- 你能在 10 分钟内完成回滚或降级（可执行）；
- 你能产出一份复盘并把失败样本回写进回归集（可复利）。[6]

## 版本化：把“变化”变成可追溯对象
AI 系统的“版本”不止代码，还包括：
- 提示与输出合同
- 检索配置与索引版本（RAG）
- 工具清单与权限边界（Agent）
- 模型版本与后训练策略

最低要求：任何一次线上行为都能指向一组明确版本（用于复盘与回放）。[6]

## 灰度发布：把风险拆小
灰度的本质是：在真实分布下验证，但把影响面控制在可承受范围内。[5]

![图 17-1：可控发布流程（版本化→灰度→观测→回滚→复盘）示意（占位）](../../assets/figure_17_1_1765971453223.png)

**模板：灰度策略卡**

| 维度 | 说明 |
| --- | --- |
| 灰度对象 | 内测用户/小比例租户/特定场景 |
| 观察窗口 | 例如：24 小时/一周（与使用周期一致） |
| 通过门槛 | 质量/延迟/成本/风险阈值 |
| 暂停条件 | 任一守门指标越界 |
| 回滚方式 | 版本回退/功能开关/降级路径 |

## 监控口径：四条线同看
AI 产品上线后至少要同看四条线：[6]
- **质量线**：用户是否解决问题（反馈、采纳率、失败样本）。
- **延迟线**：P50/P95、超时率、重试率。
- **成本线**：单次成本、日消耗、尖峰消耗。
- **风险线**：越权尝试、注入命中、敏感内容与拒答质量。

## 告警与处置：先保底，再优化
当告警触发，你的第一目标不是“修得漂亮”，而是“止损”。建议优先级：
1) 降级高成本/高风险路径（减少工具、缩短上下文、关闭某入口）
2) 限流（按用户/租户预算）
3) 回滚到上一版本
4) 进入复盘与补回归

## 模板：事故 Runbook（10 分钟版）
| 步骤 | 你要做什么 | 产出 |
| --- | --- | --- |
| 1 | 确认影响面（谁/多少/哪些功能） | 影响范围说明 |
| 2 | 触发止损（降级/限流/回滚） | 止损动作记录 |
| 3 | 保留证据（日志/请求样本/版本） | 证据包 |
| 4 | 定位根因（最小复现） | 失败样本 |
| 5 | 补门禁与回归（防复发） | 回归集更新 |
| 6 | 写复盘（结论与行动项） | 复盘文档 |

## 复现检查清单（本章最低门槛）
- 发布可追溯：能指向代码/配置/提示/模型/索引的版本组合。[6]
- 灰度可执行：通过门槛、暂停条件、回滚方式事先写清。[5]
- 四线监控可用：质量/延迟/成本/风险至少各 1 个守门指标。[6]
- Runbook 可执行：10 分钟内能止损并保留证据。[5]

## 常见陷阱（失败样本）
1. **现象**：出了事故才发现“不知道改了什么”。  
   **根因**：提示/配置/索引没有版本化，变化不可追溯。  
   **修复**：把所有影响行为的对象纳入版本管理；上线行为可回放。[6]

2. **现象**：灰度看起来没问题，全量后爆雷。  
   **根因**：灰度样本不代表真实分布；缺少守门指标。  
   **修复**：用守门指标裁决；扩大灰度覆盖面，增加攻击/边界样本。[6]

3. **现象**：回滚很慢，越拖损失越大。  
   **根因**：回滚依赖人工拼命；缺少降级路径与开关。  
   **修复**：把回滚写进发布策略；把降级当默认能力。[5]

## 交付物清单与验收标准
- 灰度策略卡与通过/暂停门槛。[5]
- 四线监控口径与阈值（质量/延迟/成本/风险）。[6]
- Runbook（含证据包与回归更新流程）。[5]

## 下一章
运维解决“如何持续上线而不爆”。下一章把评测体系写成门禁：离线/在线、红队与回归，让每次变化都可裁决。见：[`18-evaluation.md`](18-evaluation.md)。

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
