# 第 2 章：PRD 自动化与架构蓝图

> 通过对话生成标准化 PRD、流程图和数据库 Schema，减少沟通歧义并提前暴露性能瓶颈。[11][12]

!!! note "关于复现、目录与 CI"
    本章中出现的 `make ...`、`CI`、以及示例目录/文件路径（例如 `path/to/file`）均为落地约定，用于说明如何把方法落实到你自己的工程仓库中。本仓库仅提供文档，读者需自行实现或用等价工具链替代。

## 章节定位
从“需求”到“可执行设计”的桥梁。你将让 AI 生成可机读的 PRD、自动渲染流程/时序图，并产出具备容量估算的数据库设计，确保后续编码无歧义、无遗漏。[11][12][13]

## 你将收获什么
- 一套可复用的 PRD Prompt 模板与 JSON Schema 校验器，确保字段完整且可机器解析。[11]
- 自动生成流程/时序图并覆盖异常路径，降低沟通成本。[12]
- 基于 DDD 的数据库 Schema 与索引策略，提前估算延迟与吞吐瓶颈。[13][20]

## 方法论速览
1. **对话即文档：** 以 YAML/JSON 定义 PRD 结构，LLM 生成后立即用模式校验，避免“口语化”丢字段。[11]
2. **流程与时序：** 先写文字用例，再自动转 Mermaid/PlantUML；必须包含失败/补偿路径。[12]
3. **数据建模：** 从领域事件推导聚合与边界上下文，生成 SQL/NoSQL 对照方案，明确索引与容量预算。[13]

![图：PRD 到 Schema 的自动化流水线](../../assets/fig-placeholder.svg)

*图：从 YAML PRD 到 Schema/基准的自动化流水线*
<!-- TODO: replace figure with a pipeline diagram for Ch02 -->

## 典型场景
- **MVP 规划：** 两小时内完成登录、支付、内容推荐的全链路 PRD 草稿并自动校验必填字段。
- **性能先行：** 针对高并发接口，提前给出分区键、限流策略和幂等设计，避免上线后返工。

## 实战路径
```text
需求对话 → 结构化 PRD（YAML）→ Schema 校验 → 图表（时序/流程）→ OpenAPI → Schema/基准 → 评审与迭代
```

### 示例（可复制）：生成可机读 PRD（YAML）并通过字段校验

**目标：** 为“带登录与订阅计费的 SaaS”生成可机读 PRD（YAML），覆盖异常流，并可被 CI 校验通过。[11][12]

**前置条件：**
- 你已经明确一个最小业务范围（例如：登录、订阅计费、核心功能 1 个）。
- 你能在工程仓库里落地三类产物：PRD（结构化）、图表（可渲染）、接口契约（可 lint）。[11][12][20]

**上下文：**
- 项目形态：PRD 与架构蓝图的“文档即代码”流水线
- 角色：产品/架构/工程（以可机读文档减少歧义）
- 输出：`prd/mvp.yml`（YAML PRD）、`diagrams/auth.mmd`（时序图）、`openapi.yaml`（契约草案）

**约束：**
- PRD 必须包含：用户故事、埋点、错误语义、SLO、幂等与重试策略。[6][11]
- 图表必须包含失败/补偿路径（超时、重试、退款），避免“只画成功路径”。[12]
- 字段必须满足本章 Schema 校验器的 required 列表；缺失字段视为 PRD 不可用。[11]
- 若使用 AI 辅助修改代码库文件：要求它只输出统一差异格式（unified diff，git diff 格式），避免夹带解释文本。

**输出格式：**
- 产物：`prd/mvp.yml`、`diagrams/auth.mmd`、`openapi.yaml`
- 命名：PRD 建议包含 `revision` 字段，并在提交信息/变更记录里链接到决策编号。[4]

**步骤：**
1. 写一版“用例清单”（成功/失败/补偿路径），作为生成 PRD 与图表的单一输入源。[12]
2. 让 LLM 生成结构化 PRD（YAML），立即用 Schema 校验器验证 required 字段是否齐全。[11]
3. 从用例清单派生时序图/流程图（`diagrams/*.mmd`），确保每条关键链路都有失败分支。[12]
4. 生成 OpenAPI 草案并跑 lint；把错误模型、幂等语义与状态码写进契约，避免实现各自为政。[20]

**验证命令：**
```bash
make prd-validate
# 预期输出包含：Schema 校验通过 + 图表渲染成功 + OpenAPI lint 通过
```

**失败判定：**
- YAML/图表/契约任一校验失败；或 PRD 缺失 required 字段；或图表缺少失败/补偿分支。[11][12]

**回滚：**
- `git checkout -- prd/mvp.yml diagrams/auth.mmd openapi.yaml`

### 1. PRD 模板与校验
```python
import yaml, jsonschema, pathlib
schema = {
  "type": "object",
  "required": ["features", "non_functional", "tracking", "api"],
  "properties": {
    "features": {"type": "array"},
    "non_functional": {"type": "object"},
    "tracking": {"type": "object"},
    "api": {"type": "array"}
  }
}
for path in pathlib.Path("prd").glob("*.yml"):
    data = yaml.safe_load(path.read_text())
    jsonschema.validate(instance=data, schema=schema)
```
- CI 运行失败阻断合并，强制补齐字段。

### 2. 时序图生成
- 用 Prompt 生成 Mermaid 时序图，落地文件 `diagrams/*.mmd`，再用 `mmdc` 渲染 PNG，渲染失败即视为文档缺失。[12]
- 强制在图中标记超时、重试、补偿逻辑，避免“只画成功路径”。

### 3. 数据库 Schema 验证
- 依据访问模式生成 SQL 表：主键、二级索引、分区键；同时给出 NoSQL（如 Dynamo/RedisJSON）等价设计，附容量与延迟估算。[13]
- 用 Faker 生成 10 万条合成数据，跑读写基准，记录 P50/P95 延迟，超过预算即回滚设计。

### 4. API 合约与监测
- 生成 OpenAPI 规范，自动导出客户端 SDK，确保前后端并行开发。[20]
- 在 PRD 中写清埋点需求，生成事件名、属性与采样率，接入监控后回流到假设验证。

## 复现检查（落地建议）
- `make prd-validate`：校验 YAML/JSON 结构、渲染 Mermaid、生成 OpenAPI。
- `make schema-benchmark`：自动基准测试 SQL/NoSQL 方案并输出 CSV 报告。
- PRD 与图表均需在 CI 产出 PDF 供审稿人下载。

## 常见陷阱
1. **现象：** PRD 看起来完整，但实现阶段争论不断，大家各写各的。  
   **根因：** 只写成功路径，异常/补偿/错误语义缺失，导致边界条件靠口头补齐。[12]  
   **复现：** 任选一个核心链路（如登录或扣费），尝试补全“超时/重试/退款/幂等”等异常场景，通常会发现缺失。  
   **修复：** 用“用例清单”驱动 PRD 与图表：每条链路必须包含失败/补偿分支，并在 OpenAPI 里固化错误模型与状态码。[12][20]  
   **回归验证：** `make prd-validate` 必须验证图表可渲染且包含失败分支（最少 1 条），否则阻断合并。

2. **现象：** Schema/索引在评审里“看起来合理”，上线后写入变慢、成本飙升。  
   **根因：** 未结合访问模式与读写比例，索引与一致性约束堆叠造成写入放大。[13]  
   **复现：** 用合成数据跑基准（10 万行/典型查询），对比“索引少 vs 索引多”的写入耗时与 P95。  
   **修复：** 先写访问模式与容量预算，再据此决定索引；用基准数据做裁判，而不是靠经验口头拍板。[13]  
   **回归验证：** 基准报告（CSV/Markdown）随 PR 一并提交，P95 超预算则回到设计环节重做。[13]

3. **现象：** PRD/图表/契约与代码逐渐脱节，最终谁也不信文档。  
   **根因：** 文档缺少可执行门禁；变更没有单一来源与自动对比。  
   **复现：** 修改一个接口字段，检查 PRD、图表与 OpenAPI 是否同步更新；通常会发现数据不一致。  
   **修复：** 以 OpenAPI 为“可执行契约”，通过 lint、生成客户端测试与差异对比做合并门禁，把漂移变成可见的失败。[20]  
   **回归验证：** `make prd-validate` 同时跑 Schema 校验、图表渲染与 OpenAPI lint，任一失败都阻断合并。

## 延伸练习
- 让 LLM 根据埋点自动生成可视化仪表盘配置（如 Grafana JSON），上线后直接复用。
- 对比两种不同的分区策略（按用户 vs 按时间），测算成本与查询延迟差异。

## 交付物与验收（落地建议）
- `prd/*.yml`：可机读 PRD，CI 校验通过。
- `diagrams/*.mmd` 与渲染 PNG：包含异常/补偿路径。
- `schemas/`：SQL/NoSQL DDL、基准报告与容量估算表。

下面把本章的实战路径抽象为可迁移的原则，避免换团队/换工具后文档与实现漂移。

## 深度解析：核心原则
1. **对话到架构的一致性**：先让 LLM 生成“领域词汇表”，再用这些词汇驱动 PRD、时序图、API 合约与 Schema，避免不同文档使用不同名词导致歧义。所有文档引用同一份词汇表文件 `prd/vocabulary.yml`，CI 校验引用一致。[11][18]
2. **PRD 可信度与变更记录**：每个功能块附“证据来源、样本量、实验计划、决策编号”，变更时在 YAML 中递增 `revision` 并链接到决策记录，保证读者能追踪“为何修改”。[4]
3. **流水线化生成**：示例：用 `make prd` 自动生成 Markdown/HTML PRD、Mermaid 图、OpenAPI 草案与 PDF；用 `make prd-check` 运行 OpenAPI lint（例如 Spectral）、Mermaid 渲染和字段必填校验。失败即阻止合并，确保文档可视、可编译、可消费。[5][65]
4. **容量与性能假设显式化**：Schema 文件内以注释注明预估 QPS、热键分布、索引覆盖率；附基准脚本与结果 CSV。若实测 P95 超出预算则强制回到设计环节重新评审。[13]
5. **指标与埋点闭环**：在 PRD 中为注册、登录、支付、核心留存行为定义事件名与校验 SQL；建议提供一个“埋点契约测试”（示例路径：`tests/metrics/test_metrics_contract.py`）检查字段存在、类型正确，并将其设为发布门禁以避免“上线无数据”。[6]

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
