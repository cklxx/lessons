# 第 12 章：LLMOps —— 监控与评估

> 若上线后才开始评估成本与质量，往往为时已晚。本章把评估、观测与安全做成日常门禁：退化就告警，严重就阻断与回滚。[28][50][51][61][62]

!!! note "关于复现、目录与 CI"
    本章中出现的 `make ...`、`CI`、以及示例目录/文件路径（例如 `path/to/file`）均为工程约定，用于演示如何将方法应用到你自己的工程仓库中。本仓库仅提供文档，读者需自行实现或用等价工具链替代。

## 章节定位
本章旨在解决系统上线后的治理与运维难题。你将构建自动化评估、观测与安全监控体系，把 RAG/Agent/推理的关键指标纳入日常运维，让“质量回退/成本爆炸/越狱成功”都能被及时发现与处置。[28][50]

## 你将收获什么
- RAGAS/LLM-as-a-Judge 评估流水线，自动检测幻觉与引用缺失。[28][50]
- 成本与延迟监控：Token 用量、缓存命中率、队列长度、GPU 利用率，并能关联到具体请求链路。[61][62]
- Guardrails/输出过滤与审计日志，合规可追踪。[51]

## 方法论速览
1. **自动化评估：** 构建定期运行的评测集，覆盖事实性、礼貌性、安全性。[28][50]
2. **可观测性：** metrics + logs + traces，聚焦延迟、错误率、缓存、检索质量；并保证可关联、可追溯。[61][62]
3. **安全与合规：** 输出过滤、越狱检测、PII 保护与审计溯源。[51]

```text
评估（离线/在线：质量/引用/安全）
  ↘ 触发门禁（阻断发布） → 回滚（模型/配置/索引）
观测（成本/延迟/错误/缓存）
  ↘ 触发告警（提醒排障） → runbook（定位/修复）
安全（注入/越狱/PII）
  ↘ 触发熔断/降级 → 事件留档（审计）

所有结果回流到：训练/提示/检索/推理配置（形成闭环）
```

*图 12-1：LLMOps 运行闭环——评估 × 观测 × 安全 × 反馈（纯文本示意）*

## 实战路径
```text
每日评估（质量/引用/安全）→ 观测（延迟/成本）→ 门禁（阻断发布）→ 告警（提醒排障）→ 回滚（模型/配置/索引）→ 反馈（训练与提示更新）
```

### 示例（可复制）：将评估、观测与安全检查转化为每日执行的质量门禁

**目标：** 为线上 LLM 系统建立每日评估（RAGAS/Judge）、观测（成本/延迟）与安全回归（注入/越狱）三件套，把“质量不回退”变成可执行门槛。[28][50][51][61][62]

**前置条件：**
- 你有一份最小评测集（来自真实流量/工单的抽样），并能定期更新（避免陈旧导致虚高）。[28]
- 你能在请求链路里打通 `request_id/trace_id`，让评估结果能回溯到真实样本与配置版本。[61][62]

**上下文：**
- 项目形态：线上 LLM 系统（RAG/Agent/推理任一）
- 角色：运维/工程/模型（把“上线后怎么管”写成日常任务）
- 评测集：`eval/daily.jsonl`（`prompt, expected, required_citations`）
- 输出：`reports/llmops_daily.md`（分数趋势/告警触发/样本清单）

**约束：**
- 必须区分：告警阈值 vs 发布门禁阈值；并给出回滚动作。[6]
- 审计日志要能关联到 `request_id/trace_id`，支持离线复盘与追责。[61]
- 若使用 AI 辅助修改代码或文档：请要求它只输出统一差异（unified diff / `git diff` 格式），不要夹带解释文本，方便你直接应用与审查。

**输出格式：**
- 产物：评测集、日报报告、门禁阈值配置（可版本化）
- 命名：日报包含日期与版本信息（model_version/config_version/index_version）

**步骤：**
1. **准备评测集**：从真实流量抽样（覆盖高频、长尾、失败样本），标注期望行为与引用要求；每周至少刷新一次。[28]
2. **跑离线评估**：RAGAS/LLM-as-a-Judge 输出质量指标；同时记录延迟与成本（独立列）。[28][50][62]
3. **跑安全回归**：固定注入/越狱/PII 攻击集；统计命中率与拒答质量；高风险必须阻断发布。[51]
4. **生成日报**：把趋势、失败样本与“建议动作”（回滚/调参/补数据）写进 `reports/llmops_daily.md`。
5. **门禁与告警**：门禁旨在阻断风险发布，告警则用于提示线上排障；两者阈值分别校准并写清回滚动作。[6]

**验证命令：**
```bash
make llmops-eval
# 预期输出包含：日报报告 + 质量/延迟/成本/安全四类指标 + 是否触发门禁/告警与回滚建议
```

**失败判定：**
- 引用缺失/幻觉率/越狱命中率超过门禁阈值仍未阻断；或报告缺失；或无法回溯到 request_id/trace_id。[51][61]

**回滚：**
- `git checkout -- eval/ reports/`

### 1. 评测集与调度
- 将用户对话与工单转为评测样本，标注参考答案与引用。
- 每日/每周运行 RAGAS 与 LLM-as-a-Judge，将分数写入时序库，形成趋势图。[28][50]

建议把评测集按“场景桶”组织，避免平均分掩盖关键退化：[28]

| 桶 | 例子 | 指标关注点 | 典型门槛 |
|---|---|---|---|
| 事实性 | 知识问答/RAG | citation_missing/faithfulness | citation_missing=0 |
| 工具调用 | Agent | forbidden_calls/loop_count | forbidden_calls=0 |
| 安全 | 注入/越狱 | jailbreak_hit_rate | < 阈值 |
| 体验 | 礼貌/格式 | format_pass_rate | > 阈值 |

### 2. 观测与告警
- 采集 metrics：QPS、P95、缓存命中率、Token 成本、GPU/CPU 利用率、向量检索延迟。
- 设置告警阈值（示例）：如幻觉率 > 2%、引用缺失 > 5%、成本环比 > 20% 触发告警。阈值应基于历史分布、抽样误差与业务容忍度校准，并区分“告警”与“熔断/降级”策略。

建议把 LLM 系统的“最小观测集合”写成可执行清单（缺一项就很难排障）：[61][62]

- `request_id/trace_id`：贯穿网关→检索→推理→工具调用
- `model_version` / `prompt_version` / `config_version`：可定位到配置与发布批次
- 成本口径：token_in/token_out、缓存命中、单位请求成本
- 延迟分解：检索延迟/重排延迟/生成延迟/队列等待
- 错误分类：超时、限流、上游失败、解析失败、工具失败
- 安全事件：注入命中、越狱命中、PII 命中、拒答触发

```text
门禁（Gate）：
- 触发时机：发布前/灰度阶段
- 目的：阻断有风险的变更
- 动作：回滚到稳定版本（模型/配置/索引），并记录变更原因

告警（Alert）：
- 触发时机：线上运行中
- 目的：提醒排障与止损
- 动作：分级处理（triage/runbook），必要时熔断/降级；不等价于“发布回滚”
```

*图 12-2：门禁与告警的分离——门禁用于阻断发布，告警用于提醒排障，两者阈值与动作不同（纯文本示意）*

### 3. 安全与合规
- Guardrails：基于分类模型与规则的多级过滤，拒绝高风险输出。[51]
- 审计：所有请求/响应与工具调用写入审计日志，脱敏后存档。

建议把“安全与合规”做成三层防线（写清边界条件）：[51]

| 层级 | 目的 | 典型措施 |
|---|---|---|
| 输入侧 | 降低攻击面 | 注入检测、敏感词/结构过滤、来源隔离 |
| 生成侧 | 强约束输出 | 系统提示、结构化输出、引用契约 |
| 输出侧 | 阻断高风险 | 分类器/规则过滤、拒答模板、审计留痕 |

### 4. 反馈闭环
- 将用户负反馈/差评转化为偏好数据，回流第 10 章的对齐训练。
- 将观测数据（缓存命中、延迟）回流第 11 章推理配置，形成自适应调优。

```text
线上事件/负反馈/失败样本
  → 分类（质量/安全/成本/体验）
  → 分流到对应“可回归资产”：
     - 对齐训练（第 10 章）：SFT/偏好对、红队样本
     - 检索与切分（第 6 章）：新增文档、切分策略、引用契约用例
     - 推理配置（第 11 章）：量化/引擎/路由/缓存参数
  → 重新评估与灰度发布（门禁不过=回滚）
```

*图 12-3：反馈闭环——负反馈与失败样本回流训练/检索/推理配置（纯文本示意）*

## 复现检查清单
- `make llmops-eval`：运行评测集并输出分数与趋势图。
- `make llmops-observe`：启动监控栈（Prometheus/Grafana），生成示例仪表盘。[62][64]
- `make llmops-guard`：执行越狱/注入攻击测试，输出过滤效果报告。

## 常见陷阱
1. **现象：** 监控指标看似平稳，用户负面反馈却持续增加。  
   **根因：** 评测集陈旧：长期不更新导致“指标虚高”，无法覆盖新问题与分布漂移。[28]  
   **复现：** 从真实流量抽样 100 条，与评测集对比标签/场景分布；若差异大则评测失真。  
   **修复：** 每周从真实流量刷新评测；把“新失败样本入库”当作日常工作。  
   **回归验证：** 新评测集上线后，指标能解释真实反馈趋势；失败样本在报告中可追溯。

2. **现象：** 告警太多没人看，真正事故反而被淹没。  
   **根因：** 告警疲劳：阈值未校准、缺少抑制窗口与分级策略。[62]  
   **复现：** 统计告警噪声：过去一周告警数量 vs 实际需要处理的数量。  
   **修复：** 分级（P0/P1/P2）；设置窗口与抑制；把“门禁”与“告警”彻底分离；为每个告警写 runbook。[6]  
   **回归验证：** 告警数量下降但命中率上升；P0 告警能在规定时间内被处理。

3. **现象：** 成本突然飙升，事后无法定位是哪个场景/哪个版本造成的。  
   **根因：** 成本口径不一致或无法归因；缺少 request_id/版本字段导致不可追溯。[61][62]  
   **复现：** 抽 10 条高成本请求，问：来自哪个版本？哪个 prompt？是否命中缓存？若答不上来就是不可观测。  
   **修复：** 统一成本字段（token_in/out、cache_hit）；日志与指标带版本；做“成本 top N”面板。  
   **回归验证：** 成本告警触发时能定位到具体路由/版本/场景，并给出回滚动作。

4. **现象：** 发生越狱/注入/泄露事件后无法还原现场或追责。  
   **根因：** 审计缺失或不完整；工具调用/输入未记录；脱敏策略混乱。[51][61]  
   **复现：** 尝试重放一次可疑请求，发现缺少 prompt/工具调用/配置版本信息。  
   **修复：** 审计日志最小字段（request_id/trace_id/principal/model_version/prompt_version/tool_calls）；脱敏后存档并做访问控制。[51][61]  
   **回归验证：** 演练一次安全事件，能够在限定时间内重放并给出修复与回滚证据链。

## 延伸练习
- 为 RAG 系统增加“引用覆盖率”指标，要求每个答案至少引用 2 个片段。
- 集成成本优化策略：语义缓存命中率低于 30% 自动放宽相似度阈值。

## 交付物清单与验收标准
- 评测脚本、调度计划与趋势报告；告警配置与响应手册。
- 监控仪表盘模板、成本与延迟趋势图。
- 输出过滤策略、审计日志样例与合规说明。

下面把本章的运维实践抽象为可迁移原则：你可以换监控栈/评估器，但不换“可回归、可告警、可追责”的底座。

## 深度解析：核心原则
1. **评估要常态化**：把评测集与调度当作生产配置（每日/每周），让质量回退在上线前可见，而不是靠用户投诉发现。[28][50]
2. **门禁与告警分离**：告警阈值用于提醒，发布门禁用于阻断；两者要分别校准并明确回滚动作，避免“要么太松要么太吵”。[6]
3. **成本是一级指标**：Token 用量/缓存命中/队列长度要和业务请求关联；无法归因的成本优化等同于碰运气。[62]
4. **安全与审计同链路**：注入/越狱/PII 风险必须可复现、可回归；审计日志要能回答“谁在何时因为什么触发了什么输出/工具”。[51][68]

## 资料笔记（可选）
- [RAGAS（离线评估与回归门禁）](../../materials/ai-assisted-software-product/notes/ref-028-ragas.md)
- [LLM-as-a-Judge（能用在哪、不能用在哪）](../../materials/ai-assisted-software-product/notes/ref-050-llm-as-a-judge.md)
- [Guardrails（护栏与安全）](../../materials/ai-assisted-software-product/notes/ref-051-guardrails.md)
- [OpenTelemetry（观测口径与链路追踪）](../../materials/ai-assisted-software-product/notes/ref-061-opentelemetry.md)
- [Prometheus（指标监控）](../../materials/ai-assisted-software-product/notes/ref-062-prometheus.md)
- [Grafana（可视化看板）](../../materials/ai-assisted-software-product/notes/ref-064-grafana.md)
- [OWASP ASVS（安全检查项怎么落地到门禁）](../../materials/ai-assisted-software-product/notes/ref-068-owasp-asvs.md)

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
