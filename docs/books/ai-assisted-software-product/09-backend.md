# 第 9 章：后端架构：边界、幂等与可观测
![Chapter 9 Header](../../assets/chapter_09_header_1766035625708.png)

> 后端不是“把接口跑通”，而是把风险关在笼子里：错误语义一致、请求可重放、成本可止损、事故可追责。[5][6]

0→1 的后端常见两种失败：一种是“能跑但不稳”，另一种是“稳但太贵”。AI 让第二种更常见：一次看似无害的改动，可能把调用次数、上下文长度或工具链路放大，成本与延迟像潮水一样淹没你。[6]

## 章节定位
本章承接前端的“状态与可恢复”，把系统底座补齐：服务边界、错误语义、幂等与重试、审计与可观测、以及 AI 场景下的成本守门。它与用户/计费章节强相关，但这里先讲“通用底座”，细节在后续章节展开。[22]

## 你将收获什么
- 一套服务边界写法：什么放在同步链路，什么放在异步/后台，什么必须可降级。
- 一套幂等与重试策略：把“偶发失败”变成可预测事件，而不是线上事故。
- 一套可观测与审计口径：能定位、能复盘、能重放，避免“只能祈祷”。[6]

## 三层思考：后端要对“不可控”负责
### 第 1 层：读者目标
你要交付的是一个敢上线的系统：失败可恢复、退化可回滚、成本可解释。

### 第 2 层：论证链条
后端稳定的链条是：

边界清晰 → 契约与错误语义 → 幂等与重试 → 可观测与审计 → 成本与限额 → 灰度与回滚

每一环都是为了把“不确定”变成“可治理”。[6]

### 第 3 层：落地与验收
验收不是“接口返回 200”，而是：
- 失败时用户与系统都知道怎么恢复；
- 关键行为可追溯（谁、何时、对什么、做了什么、结果如何）；
- 成本/延迟越界时系统能自动止损或降级。[6][22]

## 方法论速览：先定边界，再定语义，再定止损
![图 9-1：后端可控底座（边界→语义→幂等→观测→预算→回滚）示意（占位）](../../assets/figure_09_1_1765971058740.png)

### 1) 服务边界：把“高不确定性”隔离出去
AI 相关链路天然波动更大：模型输出、外部工具、网络、数据质量都会引入不确定。建议你先划三条边界：
- **同步链路**：必须在用户等待期间完成的最短路径（越短越好）。
- **异步链路**：可后台执行、可重试、可延迟的工作（导入、索引、训练、报表）。
- **降级路径**：当 AI/外部依赖不可用时，系统如何“退一步也能工作”。[6]

### 2) 契约与错误语义：让失败“可行动”
错误语义要同时对用户与工程有效：用户知道怎么办，工程知道怎么定位。

如果你想让“失败可行动”变成可复用的规范，而不是每个接口各写各的口头约定：HTTP 语义与标准化错误载体是很好的底盘。前者决定了“能不能安全重试/缓存/代理”，后者决定了“错误能不能被前端/SDK/Agent 稳定解析并做出正确动作”。[78][79]

**模板：错误语义表**

| 错误码/类型 | 用户看到什么 | 用户能做什么 | 是否可重试 | 是否需要告警 | 备注 |
| --- | --- | --- | --- | --- | --- |
| INVALID_INPUT | 指出具体字段与原因 | 修改后重试 | 否 | 否 | 前端可校验 |
| TIMEOUT | “稍后再试/已为你保留进度” | 重试/查看进度 | 是 | 视阈值 | 需幂等 |
| PERMISSION_DENIED | “无权限” | 申请权限/切换账号 | 否 | 是 | 需审计 |

### 3) 幂等与重试：把“重复请求”变成默认情况
只要你有网络、有队列、有回调，就会有重复。正确的姿势不是“希望它别重复”，而是：
- 每个会产生副作用的动作，都有幂等键；
- 每个重试都可解释（为什么重试、重试几次、何时停止）；
- 每个外部回调都可重放（用于对账与复盘）。[5]

**模板：幂等设计卡**

| 动作 | 副作用 | 幂等键来源 | 重试策略 | 冲突处理 | 证据留档 |
| --- | --- | --- | --- | --- | --- |
| 创建订单 | 写账本/扣费 | order_id | 指数退避 + 上限 | 重复则返回同结果 | 审计事件 |
| 导入数据 | 写入/索引 | import_id | 后台重试 | 支持续传/断点 | 导入报告 |

### 4) 可观测与审计：让系统“能解释自己”
0→1 阶段不追求指标大全，但必须能定位关键链路。建议你统一三类信号：
- **日志**：结构化字段，能串起一次请求的全路径。
- **指标**：失败率、延迟、吞吐、成本等守门指标。[6]
- **追踪**：至少能关联“入口请求 → 关键下游调用”。（实现方式可随栈变化）

**模板：最小可观测字段规范**

| 字段 | 为什么必须 | 例子 |
| --- | --- | --- |
| request_id / trace_id | 串起全链路 | 入口生成并透传 |
| user_id / tenant_id | 定位影响面 | 多租户必备 |
| action | 业务语义 | “import.start” |
| result | 成功/失败与原因 | success/fail + reason |
| latency_ms | 体验与退化 | P50/P95 |
| cost | AI 场景止损 | token/调用次数/金额 |

### 5) 成本守门：把“预算”写进系统默认值
在 AI 产品里，成本不是财务报表里的事，而是运行时行为。建议你把预算做成三层：
- **单次请求预算**：超过就降级（减少上下文、跳过重排、减少工具调用）。
- **用户/租户预算**：超过就限流或切换到低成本路径。
- **全局预算**：异常尖峰时自动止损，保护现金流。[6]

**模板：预算与降级策略**

| 预算层级 | 指标 | 阈值 | 越界动作 | 回滚条件 |
| --- | --- | --- | --- | --- |
| 单次请求 | cost/latency | ≤ X | 减少上下文/工具 | 指标恢复 |
| 租户 | 日消耗 | ≤ Y | 限流/提示升级 | 次日重置 |
| 全局 | 峰值消耗 | ≤ Z | 临时关闭高成本功能 | 手动解除 |

## 复现检查清单（本章最低门槛）
- 错误语义表存在，并被前后端共同遵守（用户可行动、工程可定位）。
- 幂等与重试策略清晰：关键副作用动作都有幂等键与停止条件。[5]
- 最小可观测字段齐全：能用一次 request_id 复盘一条关键链路。[6]
- 成本守门可用：越界时有明确降级/止损动作。[6]

## 常见陷阱（失败样本）
1. **现象**：线上偶发错误难定位，靠猜。  
   **根因**：缺 request_id、缺关键字段、缺统一错误语义。  
   **修复**：先统一口径与字段，再优化性能；把可观测当作功能的一部分。[6]

2. **现象**：接口偶尔重复执行，导致数据错乱或多扣费。  
   **根因**：把“重复请求”当异常，而不是默认。  
   **修复**：幂等键 + 可重放审计；重复视为同一请求返回同结果。[5]

3. **现象**：AI 功能上线后成本不可控。  
   **根因**：没有预算与降级路径；把“更聪明”当成“无上限”。  
   **修复**：把预算写进运行时；越界即降级/限流/关闭高成本功能。[6]

## 交付物清单与验收标准
- 服务边界说明（同步/异步/降级）。
- 错误语义表（用户可行动 + 工程可定位）。
- 幂等设计卡（关键副作用动作至少 3 条）。[5]
- 可观测字段规范与守门指标阈值（含成本/延迟）。[6]

## 下一章
当后端底座可控，你可以开始引入“智能层”：让回答带证据、让行动有边界、让改动可回归。下一章见：[`10-agent-rag.md`](10-agent-rag.md)。

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
