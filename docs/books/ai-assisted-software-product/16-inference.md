# 第 16 章：推理优化：延迟、吞吐与成本的三角形
![Chapter 16 Header](../../assets/figure-placeholder.svg)

> 推理优化的本质不是“跑得更快”，而是在质量、延迟、成本之间建立可裁决的取舍：你知道为了哪一点牺牲哪一点，并且退化时能回滚。[6][44]

在 AI 产品里，推理是现金流的闸门：它决定你每一次交互的成本上限，也决定用户是否愿意把它纳入日常工作流。你可以允许偶尔不够聪明，但很难允许“经常很慢”或“经常很贵”。[6]

## 章节定位
本章承接后训练，讨论上线推理的优化策略与治理方式：如何建立基线、如何定位瓶颈、如何用预算与降级守住底线。它不假设你必须自部署模型；同样适用于托管推理，只是控制点不同。[44]

## 你将收获什么
- 一张推理三角形：质量/延迟/成本的取舍框架与守门指标。[6]
- 一套“优化顺序”：先做最便宜的，再做最昂贵的，避免盲目上重武器。
- 一份推理预算与降级策略：让你在尖峰与退化时有退路。[6]

## 三层思考：推理优化是一门治理学
### 第 1 层：读者目标
你要获得“可预测的体验与成本”：用户等待可接受，账单可解释，退化可回滚。

### 第 2 层：论证链条
推理优化链条是：

基线与口径 → 瓶颈定位 → 低成本优化 → 预算与降级 → 灰度与回滚 → 持续回归

缺基线与口径，任何优化都是不可裁决的。[6]

### 第 3 层：落地与验收
验收必须包含对比表：
- 质量是否达标（且不退化）；
- P95 延迟是否达标；
- 单次成本是否在预算内；
- 守门指标是否越界（错误率、超时率）。[6]

## 推理三角形：先把取舍写清楚
![图 16-1：质量/延迟/成本三角形与守门指标示意（占位）](../../assets/figure_16_1_1765971418977.png)

**模板：推理取舍卡**

| 维度 | 你要写清楚 |
| --- | --- |
| 质量目标 | 哪些任务必须准确，哪些允许降级 |
| 延迟目标 | P50/P95 目标与超时策略 |
| 成本目标 | 单次/日/租户预算与止损线 |
| 守门指标 | 错误率、超时率、拒答率阈值 |
| 回滚 | 退化时如何回到上一策略 |

## 优化顺序：先做最便宜的
### 1) 输入与上下文：减少“没必要的 token”
很多成本来自“把上下文塞满”。先做三件事：
- 只带必要上下文（围绕当前任务）；
- 统一输出合同，减少“解释性啰嗦”；
- 对重复内容做摘要与缓存（尤其是长对话）。[6]

### 2) 缓存与复用：把重复请求变成命中
对 0→1 产品来说，最划算的提速往往来自复用：
- 同样输入的结果缓存（短期缓存）
- 检索结果缓存（RAG 场景）
- 工具调用结果缓存（可审计且有过期策略）[6]

### 3) 并发与降级：尖峰时先保底
尖峰时的策略不是“硬顶”，而是“可控降级”：
- 先降级高成本路径（减少工具调用、减少重排、缩短上下文）
- 再限流（按用户/租户预算）
- 最后拒绝服务（明确提示与恢复入口）[6]

### 4) 模型与推理策略：最后才上重武器
更换模型、量化、并行推理等往往收益大，但也更复杂。对个人而言，只有当你已经把“口径、回归、回滚”建立起来，才值得进入这一层。[44]

## 预算与降级：把止损写成默认行为
推理系统必须知道“何时不该继续”。建议你写三层预算：
- **单次预算**：超过就降级或停止；
- **用户/租户预算**：超过就限流或提示升级；
- **全局预算**：尖峰时保护现金流与稳定性。[6]

**模板：预算与降级策略**

| 触发条件 | 你观察什么 | 你怎么降级 | 何时回滚 |
| --- | --- | --- | --- |
| 单次超时 | latency 超阈值 | 缩短上下文/跳过某步 | 指标恢复 |
| 成本超预算 | cost 超阈值 | 切换低成本路径 | 次日重置/手动 |
| 错误率上升 | timeout/error 增加 | 限流/暂停高风险入口 | 回归通过 |

## 复现检查清单（本章最低门槛）
- 推理取舍卡已写：质量/延迟/成本/回滚清晰。[6]
- 有基线对比表：优化前/后同口径对比（质量、P95、成本）。[6]
- 有降级策略：尖峰与越界时系统能自动止损并可回滚。[6]

## 常见陷阱（失败样本）
1. **现象**：优化了延迟，但质量下降，用户反而流失。  
   **根因**：没有写清质量底线；缺少回归门禁。  
   **修复**：先定质量门槛与回归；不达标就回滚。[6]

2. **现象**：成本越来越高，却说不清为什么。  
   **根因**：没有预算与审计；上下文与工具调用不透明。  
   **修复**：把成本写进可观测字段；预算越界自动降级/止损。[6]

3. **现象**：尖峰时系统崩溃，恢复慢。  
   **根因**：没有降级与限流策略；把稳定性寄托在“不会尖峰”。  
   **修复**：先设计降级路径与止损线；尖峰先保底再恢复。[6]

## 交付物清单与验收标准
- 推理取舍卡与预算阈值。[6]
- 基线与对比表（质量/延迟/成本）。[6]
- 降级与止损策略（可触发、可回滚）。[6]

## 下一章
推理优化让系统“跑得稳、跑得起”。下一章进入部署与运维：如何灰度发布、监控退化、回滚与复盘，让系统长期健康。见：[`17-deployment.md`](17-deployment.md)。

## 参考
详见本书统一参考文献列表：[`references.md`](references.md)。
