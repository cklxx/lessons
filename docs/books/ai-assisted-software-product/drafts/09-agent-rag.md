# 第 9 章：Agent 架构与 RAG：检索、工具与评测

## 本章目标

- 搭建可评测、可回归、可上线的 RAG + Agent 方案
- 解决“检索不到 / 检索错 / 回答幻觉 / 工具乱用”等核心问题
- 将 RAG/Agent 纳入产品指标与工程运维体系

## 章节结构（大纲）

### 9.1 RAG 的最小闭环

- Ingestion：解析、切分、去噪、元数据
- Index：Embedding、向量库、倒排索引（混合检索）
- Retrieval：召回、过滤、rerank
- Generation：引用、回答结构、拒答策略

### 9.2 Agent 架构：规划与工具调用

- 组件：Planner、Tool Router、Memory、Guardrails、Executor
- 工具：检索、搜索、数据库查询、工作流（比如“创建工单”）
- 安全：权限隔离、工具白名单、审计日志

### 9.3 评测与回归：RAG 不是“感觉好用”

- 检索评测：Recall@k、MRR、nDCG、覆盖率
- 生成评测：事实一致性、引用正确性、拒答质量
- 线上评测：用户反馈、点击率、解决率、成本

### 9.4 生产落地的关键工程点

- 缓存、并发、超时、降级、重试
- Prompt 版本管理与 A/B
- 数据闭环：收集失败样例 → 标注 → 回归集

## 本章交付物

- RAG 管线图（含元数据规范）
- Agent 工具清单与权限模型
- 评测集结构（问题/参考答案/引用文档/评分标准）

!!! tip "AI 提示词（复制即用）"
    我会给你 20 个真实问题与对应文档。请你：1) 设计 RAG 的切分策略与元数据字段；2) 给出检索与 rerank 的方案（含阈值建议）；3) 输出一份评测集格式（JSON Schema 或表格）；4) 给出线上监控指标与告警。用 Markdown 输出。

