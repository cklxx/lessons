# 第 15 章：推理优化：延迟、吞吐与成本

## 本章目标

- 理解推理服务的性能瓶颈与成本构成
- 用工程手段（缓存、批处理、量化、并行）获得可控的单位经济
- 把推理指标纳入产品体验（速度、稳定性、可解释性）

## 章节结构（大纲）

### 15.1 推理指标与瓶颈

- 延迟（P50/P95/P99）、吞吐（QPS）、成本（$/请求、$/token）
- 瓶颈：prefill vs decode、KV cache、上下文长度

### 15.2 优化手段

- 动态批处理、KV cache、前缀缓存、结果缓存
- 量化（INT8/INT4）、蒸馏、MoE 路由（视模型）
- 推理并行：tensor/pipeline/data parallel（视框架）

### 15.3 产品级策略

- 模型分层：快速模型 vs 质量模型（router/降级）
- 超时与降级：检索失败、模型拥塞、工具不可用

## 本章交付物

- 推理指标仪表盘（字段定义与阈值）
- 成本优化清单与实验计划

!!! tip "AI 提示词（复制即用）"
    我会给你：当前请求量、平均上下文长度、目标延迟与预算。请输出：1) 推理瓶颈分析假设；2) 3 组可执行优化方案（缓存/批处理/量化/路由）；3) 每组方案的预期收益与风险；4) 监控指标与回滚条件。用 Markdown 输出。

